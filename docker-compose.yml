# JobSpy Docker Compose é…ç½®
# æä¾›é–‹ç™¼ã€æ¸¬è©¦å’Œç”Ÿç”¢ç’°å¢ƒçš„å®¹å™¨åŒ–è§£æ±ºæ–¹æ¡ˆ

version: '3.8'

# ==================== æœå‹™å®šç¾© ====================
services:
  
  # é–‹ç™¼ç’°å¢ƒ
  jobspy-dev:
    build:
      context: .
      target: development
      dockerfile: Dockerfile
    container_name: jobspy-dev
    volumes:
      # æ›è¼‰å°ˆæ¡ˆç›®éŒ„ä»¥æ”¯æ´å³æ™‚é–‹ç™¼
      - .:/app
      # æ›è¼‰ pip å¿«å–ä»¥åŠ é€Ÿå®‰è£
      - pip-cache:/root/.cache/pip
      # æ›è¼‰ Jupyter é…ç½®
      - jupyter-config:/home/jobspy/.jupyter
    ports:
      - "8888:8888"  # Jupyter Lab
      - "8000:8000"  # é–‹ç™¼ä¼ºæœå™¨
      - "5000:5000"  # Flask é™¤éŒ¯ä¼ºæœå™¨
    environment:
      - JOBSPY_DEBUG=true
      - JOBSPY_LOG_LEVEL=DEBUG
      - JOBSPY_CACHE_ENABLED=true
      - JOBSPY_MOCK_NETWORK=false
      - PYTHONPATH=/app
    networks:
      - jobspy-network
    profiles:
      - dev
    restart: unless-stopped
    stdin_open: true
    tty: true
    command: >
      bash -c "
        echo 'ğŸš€ JobSpy é–‹ç™¼ç’°å¢ƒå•Ÿå‹•ä¸­...' &&
        echo 'ğŸ“ å¯ç”¨æœå‹™:' &&
        echo '  - Jupyter Lab: http://localhost:8888' &&
        echo '  - é–‹ç™¼ä¼ºæœå™¨: http://localhost:8000' &&
        echo 'ğŸ’¡ åŸ·è¡Œæ¸¬è©¦: docker-compose exec jobspy-dev python test_runner.py --quick' &&
        echo 'ğŸ“Š åŸ·è¡Œç¯„ä¾‹: docker-compose exec jobspy-dev python complete_async_integration_example.py' &&
        tail -f /dev/null
      "
  
  # æ¸¬è©¦ç’°å¢ƒ
  jobspy-test:
    build:
      context: .
      target: testing
      dockerfile: Dockerfile
    container_name: jobspy-test
    volumes:
      - .:/app
      - test-results:/app/test-results
    environment:
      - JOBSPY_TEST_ENV=ci
      - JOBSPY_CACHE_ENABLED=false
      - JOBSPY_MOCK_NETWORK=true
      - JOBSPY_VERBOSE=false
      - JOBSPY_TIMEOUT=60
      - JOBSPY_MAX_RETRIES=3
    networks:
      - jobspy-network
    profiles:
      - test
    command: >
      bash -c "
        echo 'ğŸ§ª JobSpy æ¸¬è©¦ç’°å¢ƒå•Ÿå‹•ä¸­...' &&
        python test_runner.py --all --coverage --report test-results/test-report.md --json test-results/test-results.json &&
        echo 'âœ… æ¸¬è©¦å®Œæˆï¼Œçµæœä¿å­˜åœ¨ test-results/ ç›®éŒ„'
      "
  
  # å–®å…ƒæ¸¬è©¦æœå‹™
  jobspy-unit-test:
    build:
      context: .
      target: testing
      dockerfile: Dockerfile
    container_name: jobspy-unit-test
    volumes:
      - .:/app
      - test-results:/app/test-results
    environment:
      - JOBSPY_TEST_ENV=ci
      - JOBSPY_CACHE_ENABLED=false
      - JOBSPY_MOCK_NETWORK=true
    networks:
      - jobspy-network
    profiles:
      - test
    command: python test_runner.py --unit --coverage
  
  # æ•´åˆæ¸¬è©¦æœå‹™
  jobspy-integration-test:
    build:
      context: .
      target: testing
      dockerfile: Dockerfile
    container_name: jobspy-integration-test
    volumes:
      - .:/app
      - test-results:/app/test-results
    environment:
      - JOBSPY_TEST_ENV=integration
      - JOBSPY_CACHE_ENABLED=true
      - JOBSPY_MOCK_NETWORK=false
    networks:
      - jobspy-network
    profiles:
      - test
    command: python test_runner.py --integration
  
  # æ•ˆèƒ½æ¸¬è©¦æœå‹™
  jobspy-performance-test:
    build:
      context: .
      target: testing
      dockerfile: Dockerfile
    container_name: jobspy-performance-test
    volumes:
      - .:/app
      - test-results:/app/test-results
    environment:
      - JOBSPY_TEST_ENV=performance
      - JOBSPY_CACHE_ENABLED=true
      - JOBSPY_MOCK_NETWORK=false
    networks:
      - jobspy-network
    profiles:
      - test
      - performance
    command: python test_runner.py --performance --report test-results/performance-report.md
  
  # ç”Ÿç”¢ç’°å¢ƒ
  jobspy-prod:
    build:
      context: .
      target: production
      dockerfile: Dockerfile
    container_name: jobspy-prod
    environment:
      - JOBSPY_ENV=production
      - JOBSPY_LOG_LEVEL=INFO
      - JOBSPY_CACHE_ENABLED=true
      - JOBSPY_MOCK_NETWORK=false
    networks:
      - jobspy-network
    profiles:
      - prod
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import jobspy; print('å¥åº·æª¢æŸ¥é€šé')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  
  # Alpine è¼•é‡ç´šç”Ÿç”¢ç’°å¢ƒ
  jobspy-alpine:
    build:
      context: .
      target: production-alpine
      dockerfile: Dockerfile
    container_name: jobspy-alpine
    environment:
      - JOBSPY_ENV=production
      - JOBSPY_LOG_LEVEL=INFO
      - JOBSPY_CACHE_ENABLED=true
    networks:
      - jobspy-network
    profiles:
      - alpine
      - prod
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import jobspy"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥æœå‹™
  jobspy-lint:
    build:
      context: .
      target: development
      dockerfile: Dockerfile
    container_name: jobspy-lint
    volumes:
      - .:/app
    environment:
      - JOBSPY_DEBUG=false
    networks:
      - jobspy-network
    profiles:
      - lint
      - dev
    command: >
      bash -c "
        echo 'ğŸ” åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥...' &&
        python test_runner.py --check &&
        echo 'âœ… ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å®Œæˆ'
      "
  
  # æ–‡æª”ç”Ÿæˆæœå‹™
  jobspy-docs:
    build:
      context: .
      target: development
      dockerfile: Dockerfile
    container_name: jobspy-docs
    volumes:
      - .:/app
      - docs-build:/app/docs/_build
    ports:
      - "8080:8000"
    environment:
      - JOBSPY_DEBUG=false
    networks:
      - jobspy-network
    profiles:
      - docs
    command: >
      bash -c "
        echo 'ğŸ“š ç”Ÿæˆæ–‡æª”...' &&
        mkdir -p docs/_build/html &&
        echo 'æ–‡æª”ç”Ÿæˆå®Œæˆï¼Œå•Ÿå‹• HTTP ä¼ºæœå™¨...' &&
        cd docs/_build/html &&
        python -m http.server 8000 --bind 0.0.0.0
      "
  
  # è³‡æ–™åº«æœå‹™ï¼ˆå¦‚æœéœ€è¦ï¼‰
  jobspy-db:
    image: postgres:13-alpine
    container_name: jobspy-db
    environment:
      - POSTGRES_DB=jobspy
      - POSTGRES_USER=jobspy
      - POSTGRES_PASSWORD=jobspy_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - jobspy-network
    profiles:
      - db
      - full
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jobspy"]
      interval: 30s
      timeout: 10s
      retries: 5
  
  # Redis å¿«å–æœå‹™ï¼ˆå¦‚æœéœ€è¦ï¼‰
  jobspy-redis:
    image: redis:7-alpine
    container_name: jobspy-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - jobspy-network
    profiles:
      - cache
      - full
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: redis-server --appendonly yes
  
  # ç›£æ§æœå‹™ï¼ˆPrometheusï¼‰
  jobspy-prometheus:
    image: prom/prometheus:latest
    container_name: jobspy-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    networks:
      - jobspy-network
    profiles:
      - monitoring
      - full
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
  
  # ç›£æ§å„€è¡¨æ¿ï¼ˆGrafanaï¼‰
  jobspy-grafana:
    image: grafana/grafana:latest
    container_name: jobspy-grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    networks:
      - jobspy-network
    profiles:
      - monitoring
      - full
    restart: unless-stopped
    depends_on:
      - jobspy-prometheus

# ==================== ç¶²è·¯å®šç¾© ====================
networks:
  jobspy-network:
    driver: bridge
    name: jobspy-network

# ==================== å·å®šç¾© ====================
volumes:
  # é–‹ç™¼ç›¸é—œ
  pip-cache:
    name: jobspy-pip-cache
  jupyter-config:
    name: jobspy-jupyter-config
  
  # æ¸¬è©¦ç›¸é—œ
  test-results:
    name: jobspy-test-results
  
  # æ–‡æª”ç›¸é—œ
  docs-build:
    name: jobspy-docs-build
  
  # è³‡æ–™åº«ç›¸é—œ
  postgres-data:
    name: jobspy-postgres-data
  redis-data:
    name: jobspy-redis-data
  
  # ç›£æ§ç›¸é—œ
  prometheus-data:
    name: jobspy-prometheus-data
  grafana-data:
    name: jobspy-grafana-data

# ==================== ä½¿ç”¨èªªæ˜ ====================
#
# åŸºæœ¬å‘½ä»¤ï¼š
#
# å•Ÿå‹•é–‹ç™¼ç’°å¢ƒï¼š
# docker-compose --profile dev up -d
#
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ï¼š
# docker-compose --profile test up jobspy-test
#
# åŸ·è¡Œå–®å…ƒæ¸¬è©¦ï¼š
# docker-compose --profile test up jobspy-unit-test
#
# åŸ·è¡Œæ•´åˆæ¸¬è©¦ï¼š
# docker-compose --profile test up jobspy-integration-test
#
# åŸ·è¡Œæ•ˆèƒ½æ¸¬è©¦ï¼š
# docker-compose --profile performance up jobspy-performance-test
#
# å•Ÿå‹•ç”Ÿç”¢ç’°å¢ƒï¼š
# docker-compose --profile prod up -d
#
# å•Ÿå‹• Alpine ç‰ˆæœ¬ï¼š
# docker-compose --profile alpine up -d
#
# ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ï¼š
# docker-compose --profile lint up jobspy-lint
#
# ç”Ÿæˆæ–‡æª”ï¼š
# docker-compose --profile docs up -d jobspy-docs
#
# å•Ÿå‹•å®Œæ•´ç’°å¢ƒï¼ˆåŒ…å«è³‡æ–™åº«å’Œç›£æ§ï¼‰ï¼š
# docker-compose --profile full up -d
#
# é€²å…¥é–‹ç™¼å®¹å™¨ï¼š
# docker-compose exec jobspy-dev bash
#
# æŸ¥çœ‹æ—¥èªŒï¼š
# docker-compose logs -f jobspy-dev
#
# åœæ­¢æ‰€æœ‰æœå‹™ï¼š
# docker-compose down
#
# æ¸…ç†æ‰€æœ‰è³‡æ–™ï¼š
# docker-compose down -v --remove-orphans
#
# ==================== é–‹ç™¼å·¥ä½œæµç¨‹ ====================
#
# 1. å•Ÿå‹•é–‹ç™¼ç’°å¢ƒï¼š
#    docker-compose --profile dev up -d
#
# 2. é€²å…¥å®¹å™¨é€²è¡Œé–‹ç™¼ï¼š
#    docker-compose exec jobspy-dev bash
#
# 3. åŸ·è¡Œå¿«é€Ÿæ¸¬è©¦ï¼š
#    docker-compose exec jobspy-dev python test_runner.py --quick
#
# 4. åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥ï¼š
#    docker-compose --profile lint up jobspy-lint
#
# 5. åŸ·è¡Œå®Œæ•´æ¸¬è©¦ï¼š
#    docker-compose --profile test up jobspy-test
#
# 6. æŸ¥çœ‹æ¸¬è©¦çµæœï¼š
#    docker-compose exec jobspy-test cat test-results/test-report.md
#
# ==================== ç”Ÿç”¢éƒ¨ç½² ====================
#
# 1. å»ºç½®ç”Ÿç”¢æ˜ åƒï¼š
#    docker-compose build jobspy-prod
#
# 2. å•Ÿå‹•ç”Ÿç”¢ç’°å¢ƒï¼š
#    docker-compose --profile prod up -d
#
# 3. æª¢æŸ¥å¥åº·ç‹€æ…‹ï¼š
#    docker-compose ps
#
# 4. æŸ¥çœ‹æ—¥èªŒï¼š
#    docker-compose logs -f jobspy-prod
#
# ==================== ç›£æ§å’Œé™¤éŒ¯ ====================
#
# 1. å•Ÿå‹•ç›£æ§æœå‹™ï¼š
#    docker-compose --profile monitoring up -d
#
# 2. è¨ªå• Grafanaï¼š
#    http://localhost:3000 (admin/admin)
#
# 3. è¨ªå• Prometheusï¼š
#    http://localhost:9090
#
# 4. æª¢æŸ¥å®¹å™¨ç‹€æ…‹ï¼š
#    docker-compose ps
#    docker-compose top
#
# 5. æŸ¥çœ‹è³‡æºä½¿ç”¨ï¼š
#    docker stats
#
# ==================== ç’°å¢ƒè®Šæ•¸æª”æ¡ˆ ====================
#
# å¯ä»¥å‰µå»º .env æª”æ¡ˆä¾†è¦†è“‹é è¨­è¨­å®šï¼š
#
# # .env
# JOBSPY_DEBUG=true
# JOBSPY_LOG_LEVEL=DEBUG
# POSTGRES_PASSWORD=your_secure_password
# GRAFANA_ADMIN_PASSWORD=your_secure_password
#
# ==================== æ“´å±•é…ç½® ====================
#
# å¯ä»¥å‰µå»º docker-compose.override.yml ä¾†æ“´å±•é…ç½®ï¼š
#
# version: '3.8'
# services:
#   jobspy-dev:
#     volumes:
#       - ./custom-config:/app/config
#     environment:
#       - CUSTOM_SETTING=value
#