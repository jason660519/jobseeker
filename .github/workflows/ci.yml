name: CI/CD Pipeline

# è§¸ç™¼æ¢ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤© UTC 02:00 åŸ·è¡Œï¼ˆå°ç£æ™‚é–“ 10:00ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_performance_tests:
        description: 'åŸ·è¡Œæ•ˆèƒ½æ¸¬è©¦'
        required: false
        default: 'false'
        type: boolean
      run_network_tests:
        description: 'åŸ·è¡Œç¶²è·¯æ¸¬è©¦'
        required: false
        default: 'false'
        type: boolean

# ç’°å¢ƒè®Šæ•¸
env:
  PYTHON_VERSION: '3.10'
  jobseeker_TEST_ENV: 'ci'
  jobseeker_CACHE_ENABLED: 'false'
  jobseeker_MOCK_NETWORK: 'true'
  jobseeker_VERBOSE: 'false'
  jobseeker_TIMEOUT: '60'
  jobseeker_MAX_RETRIES: '3'

# ä¸¦ç™¼æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================== ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ ====================
  code-quality:
    name: ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy bandit safety
        pip install -r requirements.txt
    
    - name: Black æ ¼å¼æª¢æŸ¥
      run: black --check --diff .
    
    - name: isort å°å…¥æ’åºæª¢æŸ¥
      run: isort --check-only --diff .
    
    - name: Flake8 ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥
      run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: MyPy é¡å‹æª¢æŸ¥
      run: mypy jobseeker/ --ignore-missing-imports
      continue-on-error: true
    
    - name: Bandit å®‰å…¨æª¢æŸ¥
      run: bandit -r jobseeker/ -f json -o bandit-report.json
      continue-on-error: true
    
    - name: Safety ä¾è³´å®‰å…¨æª¢æŸ¥
      run: safety check --json --output safety-report.json
      continue-on-error: true
    
    - name: ä¸Šå‚³å®‰å…¨å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 30

  # ==================== å–®å…ƒæ¸¬è©¦ ====================
  unit-tests:
    name: å–®å…ƒæ¸¬è©¦
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    needs: code-quality
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']
        exclude:
          # æ¸›å°‘ macOS æ¸¬è©¦ä»¥ç¯€çœè³‡æº
          - os: macos-latest
            python-version: '3.10'
          - os: macos-latest
            python-version: '3.10'
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-test.txt
        pip install -r requirements.txt
    
    - name: åŸ·è¡Œå–®å…ƒæ¸¬è©¦
      run: |
        python test_runner.py --unit --coverage --json unit-test-results.json
    
    - name: ä¸Šå‚³æ¸¬è©¦çµæœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: unit-test-results-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          unit-test-results.json
          htmlcov/
        retention-days: 30
    
    - name: ä¸Šå‚³è¦†è“‹ç‡åˆ° Codecov
      uses: codecov/codecov-action@v3
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # ==================== æ•´åˆæ¸¬è©¦ ====================
  integration-tests:
    name: æ•´åˆæ¸¬è©¦
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: unit-tests
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-test.txt
        pip install -r requirements.txt
    
    - name: åŸ·è¡Œæ•´åˆæ¸¬è©¦
      run: |
        python test_runner.py --integration --json integration-test-results.json
    
    - name: ä¸Šå‚³æ¸¬è©¦çµæœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: integration-test-results.json
        retention-days: 30

  # ==================== æ•ˆèƒ½æ¸¬è©¦ ====================
  performance-tests:
    name: æ•ˆèƒ½æ¸¬è©¦
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: unit-tests
    if: github.event_name == 'schedule' || github.event.inputs.run_performance_tests == 'true'
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-test.txt
        pip install -r requirements.txt
    
    - name: åŸ·è¡Œæ•ˆèƒ½æ¸¬è©¦
      env:
        jobseeker_TEST_ENV: 'performance'
      run: |
        python test_runner.py --performance --json performance-test-results.json --report performance-report.md
    
    - name: ä¸Šå‚³æ•ˆèƒ½å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-reports
        path: |
          performance-test-results.json
          performance-report.md
        retention-days: 90

  # ==================== ç¶²è·¯æ¸¬è©¦ ====================
  network-tests:
    name: ç¶²è·¯æ¸¬è©¦
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests
    if: github.event_name == 'schedule' || github.event.inputs.run_network_tests == 'true'
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-test.txt
        pip install -r requirements.txt
    
    - name: åŸ·è¡Œç¶²è·¯æ¸¬è©¦
      env:
        jobseeker_TEST_ENV: 'network'
        jobseeker_MOCK_NETWORK: 'false'
        jobseeker_NETWORK_TESTS: 'true'
      run: |
        python test_runner.py --network --json network-test-results.json
    
    - name: ä¸Šå‚³æ¸¬è©¦çµæœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: network-test-results
        path: network-test-results.json
        retention-days: 30

  # ==================== å»ºç½®æ¸¬è©¦ ====================
  build-test:
    name: å»ºç½®æ¸¬è©¦
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: code-quality
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£å»ºç½®å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        pip install -r requirements.txt
    
    - name: å»ºç½®å¥—ä»¶
      run: |
        python -m build
    
    - name: æª¢æŸ¥å¥—ä»¶
      run: |
        twine check dist/*
    
    - name: ä¸Šå‚³å»ºç½®ç”¢ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: dist/
        retention-days: 30

  # ==================== Docker æ¸¬è©¦ ====================
  docker-test:
    name: Docker æ¸¬è©¦
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: code-quality
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: å»ºç½® Docker æ˜ åƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: jobseeker:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: åœ¨ Docker ä¸­åŸ·è¡Œæ¸¬è©¦
      run: |
        docker run --rm -v ${{ github.workspace }}:/app -w /app jobseeker:test python test_runner.py --quick

  # ==================== ç›¸å®¹æ€§æ¸¬è©¦ ====================
  compatibility-test:
    name: ç›¸å®¹æ€§æ¸¬è©¦
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests
    if: github.event_name == 'schedule'
    
    strategy:
      matrix:
        python-version: ['3.10', '3.12-dev']
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        allow-prereleases: true
    
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-test.txt
        pip install -r requirements.txt
      continue-on-error: true
    
    - name: åŸ·è¡Œç›¸å®¹æ€§æ¸¬è©¦
      run: |
        python test_runner.py --quick
      continue-on-error: true

  # ==================== æ¸¬è©¦å ±å‘Šå½™ç¸½ ====================
  test-summary:
    name: æ¸¬è©¦å ±å‘Šå½™ç¸½
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [unit-tests, integration-tests]
    if: always()
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ä¸‹è¼‰æ‰€æœ‰æ¸¬è©¦çµæœ
      uses: actions/download-artifact@v3
      with:
        path: test-results/
    
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ç”Ÿæˆæ¸¬è©¦å ±å‘Š
      run: |
        python -c "
        import json
        import os
        from pathlib import Path
        
        results_dir = Path('test-results')
        all_results = []
        
        for json_file in results_dir.rglob('*.json'):
            try:
                with open(json_file) as f:
                    data = json.load(f)
                    all_results.append(data)
            except:
                pass
        
        # ç”Ÿæˆ Markdown å ±å‘Š
        with open('test-summary.md', 'w') as f:
            f.write('# jobseeker æ¸¬è©¦å ±å‘Š\n\n')
            f.write(f'**æäº¤**: {os.getenv(\"GITHUB_SHA\", \"unknown\")}\n')
            f.write(f'**åˆ†æ”¯**: {os.getenv(\"GITHUB_REF_NAME\", \"unknown\")}\n')
            f.write(f'**å·¥ä½œæµç¨‹**: {os.getenv(\"GITHUB_RUN_ID\", \"unknown\")}\n\n')
            
            total_passed = sum(r.get('summary', {}).get('total_passed', 0) for r in all_results)
            total_failed = sum(r.get('summary', {}).get('total_failed', 0) for r in all_results)
            total_skipped = sum(r.get('summary', {}).get('total_skipped', 0) for r in all_results)
            
            f.write('## æ¸¬è©¦ç¸½è¦½\n\n')
            f.write(f'- âœ… é€šé: {total_passed}\n')
            f.write(f'- âŒ å¤±æ•—: {total_failed}\n')
            f.write(f'- â­ï¸ è·³é: {total_skipped}\n')
            
            if total_passed + total_failed > 0:
                success_rate = (total_passed / (total_passed + total_failed)) * 100
                f.write(f'- ğŸ“Š æˆåŠŸç‡: {success_rate:.1f}%\n')
            
            f.write('\n## è©³ç´°çµæœ\n\n')
            for result in all_results:
                for test_result in result.get('results', []):
                    test_type = test_result.get('test_type', 'unknown')
                    passed = test_result.get('passed', 0)
                    failed = test_result.get('failed', 0)
                    duration = test_result.get('duration', 0)
                    
                    status = 'âœ…' if failed == 0 else 'âŒ'
                    f.write(f'{status} **{test_type}**: {passed} é€šé, {failed} å¤±æ•— ({duration:.2f}s)\n')
        "
    
    - name: ä¸Šå‚³æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: test-summary
        path: test-summary.md
        retention-days: 90
    
    - name: è©•è«– PRï¼ˆå¦‚æœæ˜¯ PRï¼‰
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test-summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  # ==================== éƒ¨ç½²åˆ° GitHub Pages ====================
  deploy-docs:
    name: éƒ¨ç½²æ–‡æª”
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [unit-tests, integration-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: å®‰è£æ–‡æª”ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinx-rtd-theme
        pip install -r requirements.txt
    
    - name: ä¸‹è¼‰æ¸¬è©¦å ±å‘Š
      uses: actions/download-artifact@v3
      with:
        name: test-summary
        path: docs/
    
    - name: ç”Ÿæˆæ–‡æª”
      run: |
        # å‰µå»ºç°¡å–®çš„æ–‡æª”çµæ§‹
        mkdir -p docs/_build/html
        
        # è¤‡è£½æ¸¬è©¦å ±å‘Š
        cp test-summary.md docs/_build/html/test-report.md || true
        
        # å‰µå»ºé¦–é 
        cat > docs/_build/html/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>jobseeker æ–‡æª”</title>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                h1 { color: #333; }
                .nav { margin: 20px 0; }
                .nav a { margin-right: 20px; text-decoration: none; color: #0066cc; }
            </style>
        </head>
        <body>
            <h1>jobseeker å°ˆæ¡ˆæ–‡æª”</h1>
            <div class="nav">
                <a href="test-report.md">æ¸¬è©¦å ±å‘Š</a>
                <a href="https://github.com/your-username/jobseeker">GitHub å€‰åº«</a>
            </div>
            <h2>å°ˆæ¡ˆç°¡ä»‹</h2>
            <p>jobseeker æ˜¯ä¸€å€‹å¼·å¤§çš„è·ä½è³‡è¨Šçˆ¬èŸ²å·¥å…·ï¼Œæ”¯æ´å¤šç¶²ç«™çˆ¬å–ã€éåŒæ­¥è™•ç†å’Œæ™ºèƒ½å¿«å–ã€‚</p>
            
            <h2>ä¸»è¦åŠŸèƒ½</h2>
            <ul>
                <li>å¤šç¶²ç«™è·ä½çˆ¬å–</li>
                <li>éåŒæ­¥è™•ç†æ”¯æ´</li>
                <li>æ™ºèƒ½å¿«å–æ©Ÿåˆ¶</li>
                <li>çµ±ä¸€éŒ¯èª¤è™•ç†</li>
                <li>æ•ˆèƒ½ç›£æ§</li>
                <li>è³‡æ–™å“è³ªæ”¹å–„</li>
            </ul>
            
            <h2>å¿«é€Ÿé–‹å§‹</h2>
            <pre><code>pip install jobseeker
        
        from jobseeker import scrape_jobs
        
        jobs = scrape_jobs(
            site_name="indeed",
            search_term="python developer",
            location="Sydney, NSW",
            results_wanted=50
        )
        
        print(f"æ‰¾åˆ° {len(jobs)} å€‹è·ä½")
            </code></pre>
        </body>
        </html>
        EOF
    
    - name: è¨­ç½® Pages
      uses: actions/configure-pages@v3
    
    - name: ä¸Šå‚³åˆ° Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: docs/_build/html
    
    - name: éƒ¨ç½²åˆ° Pages
      id: deployment
      uses: actions/deploy-pages@v2

  # ==================== é€šçŸ¥ ====================
  notify:
    name: é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [test-summary]
    if: always() && (github.event_name == 'schedule' || github.ref == 'refs/heads/main')
    
    steps:
    - name: é€šçŸ¥çµæœ
      uses: actions/github-script@v6
      with:
        script: |
          const needs = ${{ toJSON(needs) }};
          const failed_jobs = Object.entries(needs)
            .filter(([name, job]) => job.result === 'failure')
            .map(([name]) => name);
          
          if (failed_jobs.length > 0) {
            console.log(`âŒ å¤±æ•—çš„å·¥ä½œ: ${failed_jobs.join(', ')}`);
          } else {
            console.log('âœ… æ‰€æœ‰å·¥ä½œéƒ½æˆåŠŸå®Œæˆ');
          }
